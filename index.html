<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forensics Quiz Scoreboard 2025</title>
  <style>
    /* ---------- THEME ---------- */
    :root{
      --accent: #6366f1; /* default (MAIN) */
      --bg: #0b1220;
      --surface: #0f172a;
      --surface-2: #111827;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.3);
      --radius: 18px;
    }
    body.theme-RED    { --accent:#ef4444; }
    body.theme-GREEN  { --accent:#22c55e; }
    body.theme-BLUE   { --accent:#3b82f6; }
    body.theme-YELLOW { --accent:#f59e0b; }

    /* ---------- LAYOUT ---------- */
    html,body{height:100%;}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, color-mix(in oklab, var(--accent) 35%, transparent), transparent),
        radial-gradient(1200px 600px at 110% 10%, color-mix(in oklab, var(--accent) 20%, transparent), transparent),
        linear-gradient(180deg, #0b1220, #0a0f1a 60%, #090e18);
    }
    .wrap{max-width:1200px; margin:24px auto; padding:16px;}

    .card{background:linear-gradient(180deg, color-mix(in oklab, var(--surface) 95%, transparent), var(--surface)); border:1px solid #1f2937; box-shadow:var(--shadow); border-radius:var(--radius);}
    .pad{padding:18px;}

    .titlebar{
      text-align:center; padding:24px 12px 12px; position:relative;
    }
    .titlebar h1{ margin:0; font-size: clamp(20px, 3vw, 34px); letter-spacing:.3px; }
    .subtitle{ color:var(--muted); font-size:14px; margin-top:6px; }

    .view-buttons{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:14px 0 6px; }
    .btn{
      appearance:none; border:1px solid #263041; background:linear-gradient(180deg, color-mix(in oklab, var(--surface-2) 92%, transparent), var(--surface-2));
      color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; letter-spacing:.2px; transition:200ms ease;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.25); }
    .btn.active, .btn.primary{ border-color: color-mix(in oklab, var(--accent) 60%, #263041); outline:1px solid color-mix(in oklab, var(--accent) 45%, transparent); }

    .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; margin:16px 0; }
    .toolbar .btn{ padding:9px 12px; }
    .accent{ background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 25%, var(--surface-2)), color-mix(in oklab, var(--accent) 15%, var(--surface-2))); border-color: color-mix(in oklab, var(--accent) 60%, #263041); }

    .pill{ font-size:12px; padding:6px 10px; border-radius:999px; background:color-mix(in oklab, var(--accent) 15%, #0f172a); border:1px solid color-mix(in oklab, var(--accent) 45%, #1f2937); }

    .grid{ overflow:auto; border-top:1px solid #1f2937; }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{ position:sticky; top:0; backdrop-filter: blur(6px); background:linear-gradient(180deg, color-mix(in oklab, var(--surface) 92%, transparent), var(--surface)); border-bottom:1px solid #1f2937; padding:12px; font-size:13px; text-transform:uppercase; letter-spacing:.08em; color:#b6c2d2; }
    tbody td{ border-bottom:1px solid #162033; padding:10px; }
    tbody tr:hover td{ background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 6%, transparent), transparent); }

    .team-input{ width:100%; background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius:10px; padding:9px 10px; }
    .score-cell{ display:grid; grid-template-rows:auto auto; gap:6px; }
    .score-input{ width:80px; max-width:100%; text-align:center; background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius:10px; padding:8px; }
    .mini-row{ display:flex; justify-content:center; gap:6px; }
    .mini{ font-size:12px; padding:6px 10px; border-radius:8px; border:1px solid #283246; background:#0e1624; color:#cbd5e1; cursor:pointer; }

    .total-badge{ display:inline-block; padding:6px 10px; border-radius:12px; background: color-mix(in oklab, var(--accent) 12%, #0f172a); border:1px solid color-mix(in oklab, var(--accent) 40%, #1f2937); font-weight:700; }
    .house-chip{ font-weight:700; letter-spacing:.04em; }

    .footer{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-top:14px; color:var(--muted); font-size:12px; }
    .right{ display:flex; gap:8px; align-items:center; }

    .hidden{ display:none !important; }

    /* Responsive tweaks */
    @media (max-width:700px){
      .score-input{ width:64px; }
      thead th, tbody td{ padding:8px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="titlebar">
        <h1 id="appTitle">Forensics Quiz Scoreboard 2025 — <span id="viewLabel">MAIN</span></h1>
        <div class="subtitle">Overall scoreboard (MAIN). Switch to a House to manage its teams & scores. Everything auto‑saves.</div>
        <div class="view-buttons pad">
          <button class="btn primary" data-view="MAIN" id="btnMain">Main Scoreboard</button>
          <button class="btn" data-view="RED"   id="btnRED"><span class="house-chip">RED</span></button>
          <button class="btn" data-view="GREEN" id="btnGREEN"><span class="house-chip">GREEN</span></button>
          <button class="btn" data-view="BLUE"  id="btnBLUE"><span class="house-chip">BLUE</span></button>
          <button class="btn" data-view="YELLOW"id="btnYELLOW"><span class="house-chip">YELLOW</span></button>
        </div>
      </div>

      <div class="pad">
        <div class="toolbar">
          <button class="btn accent" id="addTeamBtn">+ Add Team</button>
          <button class="btn" id="addRoundBtn">+ Add Round</button>
          <button class="btn" id="removeRoundBtn">− Remove Last Round</button>
          <button class="btn" id="resetViewBtn">Reset Current View</button>
          <button class="btn" id="clearAllBtn">Clear All Data</button>
          <span class="pill">Rounds: <strong id="roundCount">0</strong></span>
          <label class="btn" for="importFile">Import JSON</label>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
          <button class="btn" id="exportBtn">Export JSON</button>
          <label class="btn" for="toggleSort"><input type="checkbox" id="toggleSort"/> Sort by Total</label>
        </div>
      </div>

      <div class="grid pad" id="tableWrap">
        <!-- table injected here -->
      </div>

      <div class="pad footer">
        <div>Tip: Click a House (RED/GREEN/BLUE/YELLOW) to switch theme + filter teams. MAIN shows all teams.</div>
        <div class="right"><span>Theme:</span> <span class="pill" id="themeName">MAIN</span></div>
      </div>
    </div>
  </div>

  <script>
    /* ===============================
       SCOREBOARD — MULTI‑HOUSE (LOCALSTORAGE)
       Works on GitHub Pages (no server)
       =============================== */

    const LS_KEY = 'forensics_scoreboard_v3';

    /** @typedef {{id:string,name:string,house:'RED'|'GREEN'|'BLUE'|'YELLOW',scores:number[]}} Team */
    /** @typedef {{rounds:number, teams:Team[], settings:{title:string,lastView:string, sortByTotal:boolean}}} State */

    /** @type {State} */
    let state = null;
    let currentView = 'MAIN';

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function uid(){ return 't' + Math.random().toString(36).slice(2,9); }

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(raw){
          state = JSON.parse(raw);
          // Data guards
          state.rounds = Math.max(1, Number(state.rounds||1));
          state.teams = Array.isArray(state.teams) ? state.teams : [];
          state.settings = Object.assign({title:'Forensics Quiz Scoreboard 2025', lastView:'MAIN', sortByTotal:false}, state.settings||{});
        } else {
          state = { rounds: 5, teams: [], settings: { title:'Forensics Quiz Scoreboard 2025', lastView:'MAIN', sortByTotal:false } };
        }
      }catch(e){
        console.error('Load failed, resetting.', e);
        state = { rounds: 5, teams: [], settings: { title:'Forensics Quiz Scoreboard 2025', lastView:'MAIN', sortByTotal:false } };
      }
      currentView = state.settings.lastView || 'MAIN';
      applyTheme(currentView);
    }

    function save(){
      try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
      catch(e){ console.warn('Save failed', e); }
    }

    const saveDebounced = (function(){
      let t=null; return function(){ clearTimeout(t); t=setTimeout(save, 250); };
    })();

    function applyTheme(view){
      const themeName = (view==='MAIN') ? 'MAIN' : view;
      document.body.classList.remove('theme-RED','theme-GREEN','theme-BLUE','theme-YELLOW');
      if(view!=='MAIN') document.body.classList.add('theme-'+view);
      $('#themeName').textContent = themeName;
      $('#viewLabel').textContent = themeName;
      $$('.view-buttons .btn').forEach(b=> b.classList.toggle('active', b.dataset.view===view));
      $('#appTitle').innerHTML = `${state.settings.title} — <span id="viewLabel">${themeName}</span>`;
    }

    function visibleTeams(){
      if(currentView==='MAIN') return [...state.teams];
      return state.teams.filter(t=>t.house===currentView);
    }

    function ensureScoresLength(){
      // Ensure each team has scores array length === state.rounds
      state.teams.forEach(t=>{
        t.scores = Array.isArray(t.scores) ? t.scores : [];
        if(t.scores.length < state.rounds){
          while(t.scores.length < state.rounds) t.scores.push(0);
        } else if(t.scores.length > state.rounds){
          t.scores = t.scores.slice(0, state.rounds);
        }
      });
    }

    function sum(arr){ return arr.reduce((a,b)=> a + (Number(b)||0), 0); }

    function render(){
      ensureScoresLength();
      const teams = visibleTeams();
      if($('#toggleSort').checked){ teams.sort((a,b)=> sum(b.scores)-sum(a.scores)); }

      const thead = [`<thead><tr><th style="min-width:220px;text-align:left">Team</th>`];
      for(let i=0;i<state.rounds;i++) thead.push(`<th>R${i+1}</th>`);
      thead.push(`<th>Total</th><th style="width:1%"></th></tr></thead>`);

      const rows = teams.map(team=>{
        const scoreCells = team.scores.map((val, idx)=>`
          <td>
            <div class="score-cell">
              <input class="score-input" type="number" min="0" step="1" value="${val}" data-team="${team.id}" data-round="${idx}" />
              <div class="mini-row">
                <button class="mini" data-act="dec" data-team="${team.id}" data-round="${idx}">−</button>
                <button class="mini" data-act="inc" data-team="${team.id}" data-round="${idx}">+</button>
              </div>
            </div>
          </td>`).join('');
        const total = sum(team.scores);
        return `<tr>
          <td>
            <input class="team-input" type="text" value="${escapeHtml(team.name)}" data-team-name="${team.id}" />
            <div class="subtitle" style="font-size:11px;margin-top:6px">House: <span class="house-chip">${team.house}</span></div>
          </td>
          ${scoreCells}
          <td><span class="total-badge">${total}</span></td>
          <td><button class="mini" data-act="removeTeam" data-team="${team.id}">Delete</button></td>
        </tr>`
      }).join('');

      const tfoot = `
        <tfoot><tr>
          <th style="text-align:left">Totals</th>
          ${Array.from({length:state.rounds}).map((_,i)=>`<th>${sum(teams.map(t=> Number(t.scores[i])||0))}</th>`).join('')}
          <th>${sum(teams.map(t=> sum(t.scores)))}</th>
          <th></th>
        </tr></tfoot>`;

      const html = `<table>${thead.join('')}${rows?`<tbody>${rows}</tbody>`:`<tbody><tr><td colspan="${state.rounds+3}" style="text-align:center;color:var(--muted);padding:22px">No teams yet in this view. Click <strong>+ Add Team</strong> to begin.</td></tr></tbody>`}${tfoot}</table>`;

      $('#tableWrap').innerHTML = html;
      $('#roundCount').textContent = String(state.rounds);
      saveDebounced();
    }

    function addTeamPrompt(){
      let defaultName = `Team ${state.teams.length+1}`;
      const name = prompt('Team name?', defaultName);
      if(!name) return;
      let house = currentView;
      if(currentView==='MAIN'){
        house = prompt('House for this team? (RED / GREEN / BLUE / YELLOW)', 'RED');
        if(!house) return; house = house.toUpperCase().trim();
        if(!['RED','GREEN','BLUE','YELLOW'].includes(house)){ alert('Please enter one of: RED, GREEN, BLUE, YELLOW'); return; }
      }
      state.teams.push({ id: uid(), name: name.trim(), house, scores: Array.from({length: state.rounds}, ()=>0) });
      render();
    }

    function removeTeam(teamId){
      const team = state.teams.find(t=>t.id===teamId);
      if(!team) return;
      if(!confirm(`Delete team "${team.name}"?`)) return;
      state.teams = state.teams.filter(t=>t.id!==teamId);
      render();
    }

    function addRound(){ state.rounds = Math.min(100, state.rounds + 1); render(); }
    function removeRound(){ if(state.rounds>1){ state.rounds -= 1; render(); } }

    function resetCurrentView(){
      const teams = visibleTeams();
      if(!teams.length){ alert('No teams in this view.'); return; }
      if(!confirm('Reset ALL scores in the current view to 0?')) return;
      const ids = new Set(teams.map(t=>t.id));
      state.teams.forEach(t=>{ if(ids.has(t.id)) t.scores = t.scores.map(()=>0); });
      render();
    }

    function clearAll(){
      if(!confirm('Completely clear ALL teams & scores? This cannot be undone.')) return;
      state.teams = [];
      state.rounds = 5;
      render();
    }

    function setView(view){
      currentView = view;
      state.settings.lastView = view;
      applyTheme(view);
      render();
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'forensics_scoreboard.json';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(a.href), 5000);
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = e => {
        try{
          const obj = JSON.parse(String(e.target.result));
          if(!obj || typeof obj !== 'object') throw new Error('Invalid JSON');
          // simple validation
          obj.rounds = Math.max(1, Number(obj.rounds||1));
          obj.teams = Array.isArray(obj.teams) ? obj.teams : [];
          obj.settings = Object.assign({title:'Forensics Quiz Scoreboard 2025', lastView:'MAIN', sortByTotal:false}, obj.settings||{});
          state = obj;
          currentView = state.settings.lastView || 'MAIN';
          applyTheme(currentView);
          render();
        }catch(err){ alert('Import failed: '+err.message); }
      };
      reader.readAsText(file);
    }

    function attachEvents(){
      // View switching
      $$('.view-buttons .btn').forEach(btn=>{
        btn.addEventListener('click', ()=> setView(btn.dataset.view));
      });

      $('#addTeamBtn').addEventListener('click', addTeamPrompt);
      $('#addRoundBtn').addEventListener('click', addRound);
      $('#removeRoundBtn').addEventListener('click', removeRound);
      $('#resetViewBtn').addEventListener('click', resetCurrentView);
      $('#clearAllBtn').addEventListener('click', clearAll);
      $('#exportBtn').addEventListener('click', exportJSON);
      $('#importFile').addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0]; if(f) importJSON(f);
        e.target.value = '';
      });
      $('#toggleSort').addEventListener('change', (e)=>{ state.settings.sortByTotal = e.target.checked; render(); });

      // Delegated events inside table
      $('#tableWrap').addEventListener('input', (e)=>{
        const el = e.target;
        if(el.matches('[data-team-name]')){
          const team = state.teams.find(t=> t.id === el.dataset.teamName);
          if(team){ team.name = el.value.slice(0, 60); saveDebounced(); }
        }
        if(el.matches('.score-input')){
          const team = state.teams.find(t=> t.id === el.dataset.team);
          const idx = Number(el.dataset.round);
          if(team && !Number.isNaN(idx)){
            const v = clampInt(el.value, 0, 9999);
            team.scores[idx] = v; // sanitized
            // Update total badge cell without full re-render
            const row = el.closest('tr');
            if(row){
              const total = sum(team.scores);
              const badge = row.querySelector('.total-badge'); if(badge) badge.textContent = String(total);
              // update column totals footer
              updateFooterTotals();
            }
            saveDebounced();
          }
        }
      });

      $('#tableWrap').addEventListener('click', (e)=>{
        const el = e.target;
        if(!(el instanceof HTMLElement)) return;
        if(el.dataset.act === 'inc' || el.dataset.act === 'dec'){
          const team = state.teams.find(t=> t.id === el.dataset.team);
          const idx = Number(el.dataset.round);
          if(!team) return;
          let val = Number(team.scores[idx]||0);
          val += (el.dataset.act==='inc' ? 1 : -1);
          if(val<0) val = 0; if(val>9999) val = 9999;
          team.scores[idx] = val;
          // reflect in the paired input field
          const input = el.parentElement?.previousElementSibling;
          if(input && input.classList.contains('score-input')) input.value = String(val);
          // Update totals minimally
          const row = el.closest('tr');
          if(row){ const badge = row.querySelector('.total-badge'); if(badge) badge.textContent = String(sum(team.scores)); }
          updateFooterTotals();
          saveDebounced();
        }
        if(el.dataset.act === 'removeTeam'){
          removeTeam(el.dataset.team);
        }
      });
    }

    function updateFooterTotals(){
      const table = $('#tableWrap table'); if(!table) return;
      const teams = visibleTeams();
      // Update per-round totals
      const foot = table.tFoot; if(!foot) return;
      const cells = foot.rows[0].cells; // [0] is label, last is empty
      for(let i=0;i<state.rounds;i++){
        const tot = sum(teams.map(t=> Number(t.scores[i])||0));
        cells[i+1].textContent = String(tot);
      }
      cells[state.rounds+1].textContent = String(sum(teams.map(t=> sum(t.scores))));
    }

    function clampInt(v, min, max){
      v = Math.round(Number(v||0)); if(Number.isNaN(v)) v = 0; return Math.min(max, Math.max(min, v));
    }

    function escapeHtml(str){
      return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    // Init
    load();
    attachEvents();
    // Restore sort toggle
    const sortChk = $('#toggleSort'); if(sortChk) sortChk.checked = !!state.settings.sortByTotal;
    setView(currentView || 'MAIN');
  </script>
</body>
</html>